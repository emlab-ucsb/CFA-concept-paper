---
title: "Fishing effort around SIDS"
output: html_notebook
---

```{r include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warnings = FALSE, message = FALSE)
```
```{r}
# Necessary libraries
library(tidyverse)
library(bigrquery)
library(sf)
library(lwgeom)

# Bigquery project
ucsb_project <-  "ucsb-gfw"

# Read in EEZ data
SID_country_list <- read_csv(here::here("data", "SID_country_list.csv"))
SID_codes <- SID_country_list$mrgid_eez

SID_eez_boundaries <- st_read(here::here("data", "World_EEZ_v10_20180221/"), layer="eez_boundaries_v10", stringsAsFactors=FALSE, as_tibble=TRUE) %>%
    filter(Line_type == "200 NM") %>%
  dplyr::select(mrgid_eez = MRGID_EEZ1, territory = Territory1, sovereign = Sovereign1) %>%
  filter(mrgid_eez %in% SID_codes)

# Make land
world_land <-
  st_as_sf(rworldmap::countriesLow) ## data(countriesLow) is from the rworldmap package

```

```{r}
# Pull out data for SIDs
SID_codes_string <- paste(SID_codes, collapse = ', ')

sql <- paste0("
SELECT
*
FROM
  `ucsb-gfw.ocean_halos.full_dataset`
WHERE 
  mrgid_eez IN (", SID_codes_string, ")
  AND year = 2017")

final_eez_dataset <- bq_project_query(ucsb_project, sql) %>% 
  bq_table_download(max_results = Inf)
write_csv(final_eez_dataset, path = here::here("data", "final_SID_eez_dataset_2017.csv"))

# Plot
fishing_line <- final_eez_dataset %>%
  filter(year == 2017) %>%
  #filter(closest_eez_boundary_sovereign == "AUS") %>%
  mutate(lat_bin = floor(lat_bin / 0.25) * 0.25 + 0.125,
         lon_bin = floor(lon_bin / 0.25) * 0.25 + 0.125,
         distance_to_eez_boundary_km = distance_to_eez_boundary_meters / 1000) %>%
  group_by(foreign_flag,lat_bin,lon_bin) %>%
  summarize(fishing_hours = sum(fishing_hours),
            distance_to_eez_boundary_km = mean(distance_to_eez_boundary_km)) %>%
  ungroup() %>%
  mutate(foreign_flag = ifelse(foreign_flag,"Foreign fleet","Domestic fleet")) %>%
  ggplot()+
  geom_sf(data=world_land, color = NA, fill="grey30") +
    geom_tile(aes(x = lon_bin,y=lat_bin,fill = fishing_hours)) +
    geom_sf(data=eez_boundary,color="grey80",size=0.1) +
  scale_fill_viridis_c(trans="log",name="Fishing hours",labels = fancy_scientific,breaks = c(1e2,1e3,1e4)) +
  xlab("") +
  ylab("") +
  theme(plot.title = element_text(color="black",hjust=0,vjust=1, size=20),
        panel.background = element_rect(fill ="black"),
        legend.text = element_text(color = "black", size = 20),
        legend.title = element_text(color = "black", size = 20),
        legend.title.align = 1,
        legend.background = element_rect(fill="white"),
        legend.direction="horizontal",
        legend.position = "bottom",
        legend.justification = "center",
        axis.text = element_text(color = "black", size = rel(1)),
        panel.grid.major = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        plot.margin=grid::unit(c(0,0,0,0), "mm")) +
  labs(title = "2017 fishing effort along EEZ / high seas boundaries") +
 guides(fill=guide_legend(
                 keywidth=0.25,
                 keyheight=0.25,
                 default.unit="inch")) +

```

